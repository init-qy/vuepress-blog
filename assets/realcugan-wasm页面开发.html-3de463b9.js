import{_ as t,r,o as i,c,a as n,b as e,d as s,e as o}from"./app-10d891be.js";const l={},p={href:"https://git-scm.com/book/en/v2/Git-Tools-Submodules",target:"_blank",rel:"noopener noreferrer"},u={href:"https://github.com/emscripten-core/emscripten",target:"_blank",rel:"noopener noreferrer"},d={href:"https://naiveui.com",target:"_blank",rel:"noopener noreferrer"},m={href:"https://web.dev/coop-coep/",target:"_blank",rel:"noopener noreferrer"},h=n("a",{href:"../tools/realcugan-ncnn-webassembly"},"página de herramientas",-1),k=n("h2",{id:"antecedentes",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#antecedentes","aria-hidden":"true"},"#"),e(" Antecedentes")],-1),g={href:"https://github.com/bilibili/ailab/tree/main/Real-CUGAN",target:"_blank",rel:"noopener noreferrer"},b={href:"https://real-cugan.animesales.xyz/",target:"_blank",rel:"noopener noreferrer"},v=n("h2",{id:"proceso",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#proceso","aria-hidden":"true"},"#"),e(" Proceso")],-1),_=n("code",null,"wasm",-1),f={href:"https://github.com/hanFengSan/realcugan-ncnn-webassembly",target:"_blank",rel:"noopener noreferrer"},y=n("code",null,"models-pro",-1),q={href:"https://github.com/nihui/realcugan-ncnn-vulkan/tree/master/models/models-pro",target:"_blank",rel:"noopener noreferrer"},x=n("h3",{id:"git-submodule",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#git-submodule","aria-hidden":"true"},"#"),e(" git submodule")],-1),w={href:"https://github.com/hanFengSan/realcugan-ncnn-webassembly",target:"_blank",rel:"noopener noreferrer"},z=n("code",null,"git submodule",-1),E=n("code",null,"git submodule update --init",-1),j=n("code",null,"submodule",-1),C=n("code",null,"ncnn",-1),P={href:"https://github.com/nihui/realcugan-ncnn-vulkan/tree/master/models/models-pro",target:"_blank",rel:"noopener noreferrer"},A=o(`<p>Al mismo tiempo, agregué <code>emsdk</code> al <code>submodule</code>, lo que me permitió configurar <code>emscripten</code> directamente en <code>github action</code> y completar el proceso de compilación posterior.</p><h3 id="emscripten" tabindex="-1"><a class="header-anchor" href="#emscripten" aria-hidden="true">#</a> emscripten</h3><p>Como esta vez no desarrollé completamente el <code>wasm</code>, solo realicé algunas actualizaciones y migraciones según el repositorio del experto, no tengo un profundo conocimiento de ello, solo hay tres puntos a tener en cuenta:</p><ul><li>Es mejor especificar la versión de emscripten, ya que no estoy seguro si las nuevas versiones tienen actualizaciones destructivas y no encontré documentación detallada de las actualizaciones.</li><li><code>-sEXPORTED_FUNCTIONS</code> especifica las funciones de salida y las expone en <code>Module</code>. Si encuentras <code>_xxFun not defined</code>, debes modificarlo en <code>CMakeList.txt</code>.</li><li>Es necesario borrar la caché de compilación, de lo contrario podrían surgir problemas inesperados.</li></ul><h3 id="introduccion-de-unocss-y-naive-ui" tabindex="-1"><a class="header-anchor" href="#introduccion-de-unocss-y-naive-ui" aria-hidden="true">#</a> Introducción de Unocss y Naive Ui</h3><p>Unocss es relativamente simple y no he encontrado problemas de superposición de estilos, solo necesita ser configurado:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token function">Unocss</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;per-module&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Naive Ui es un poco más complejo y requiere algunos pasos:</p><ul><li>En primer lugar, no se puede utilizar el método de referencia automática de la serie <code>unplugin</code> para escribir el código, debe ser importado manualmente.</li><li>Luego, es necesario envolver el componente con el componente <code>&lt;ClientOnly&gt;</code> en el nivel más externo para omitir la compilación ssg.</li><li>Los componentes como message, dialog, etc., se utilizan a través de <code>createDiscreteApi</code>.</li><li>Por último, es necesario configurar el ssr para que se pueda compilar correctamente:</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>ssr<span class="token operator">:</span> <span class="token punctuation">{</span>
  noExternal<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;naive-ui&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;vueuc&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;date-fns&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10),L={href:"https://github.com/init-qy/vuepress-blog/blob/master/docs/.vuepress/config.ts#L46-L55",target:"_blank",rel:"noopener noreferrer"},N=o(`<h3 id="uso-de-archivos-wasm" tabindex="-1"><a class="header-anchor" href="#uso-de-archivos-wasm" aria-hidden="true">#</a> Uso de archivos wasm</h3><p>Después de generar los archivos con <code>emscripten</code>, necesitamos colocarlos en la misma carpeta que los archivos de modelo para que puedan ser leídos y utilizados por estos modelos. Durante el desarrollo, tuve muchos problemas con la ubicación de lectura de estos archivos. El archivo js generado lee el modelo <code>.bin</code> utilizando una ruta relativa, y la ruta de mi página es <code>/tools/realcugan-ncnn-webassembly.html</code>, lo que significa que intentará obtener el archivo <code>/tools/xxx.bin</code>. Esto implica que debo colocar los archivos generados <code>.js, .wasm, .bin</code> en la carpeta <code>public/tools</code>.</p><p>Además, debido al soporte de <code>i18n</code>, no se puede leer el modelo <code>.bin</code> desde otra URL en inglés, como <code>/en/tools/realcugan-ncnn-webassembly.html</code>. Si esto fuera en mi propio servidor, sería fácil de solucionar, simplemente escribiría una redirección en nginx. Sin embargo, como mi sitio web está alojado en <code>github.io</code>, la forma más fácil y rápida de solucionar esto es colocar una copia completa de los archivos de recursos en la carpeta correspondiente. La desventaja es que ocupa más espacio de almacenamiento en el repositorio. En mi caso, utilicé un método muy &quot;hack&quot; para redirigirlo forzadamente a través de un &quot;work server&quot;.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// do something Redirect</span>
<span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.+\\/en\\/tools\\/.+\\.(js|wasm|bin|param|data|jpg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;/en/tools&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/tools&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cache</span><span class="token operator">:</span> request<span class="token punctuation">.</span>cache<span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> request<span class="token punctuation">.</span>credentials<span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
    <span class="token literal-property property">integrity</span><span class="token operator">:</span> request<span class="token punctuation">.</span>integrity<span class="token punctuation">,</span>
    <span class="token literal-property property">destination</span><span class="token operator">:</span> request<span class="token punctuation">.</span>destination<span class="token punctuation">,</span>
    <span class="token literal-property property">keepalive</span><span class="token operator">:</span> request<span class="token punctuation">.</span>keepalive<span class="token punctuation">,</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> request<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> request<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
    <span class="token literal-property property">redirect</span><span class="token operator">:</span> request<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    <span class="token literal-property property">referrer</span><span class="token operator">:</span> request<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span>
    <span class="token literal-property property">referrerPolicy</span><span class="token operator">:</span> request<span class="token punctuation">.</span>referrerPolicy<span class="token punctuation">,</span>
    <span class="token literal-property property">signal</span><span class="token operator">:</span> request<span class="token punctuation">.</span>signal<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="actualizacion-del-2-de-agosto-de-2023" tabindex="-1"><a class="header-anchor" href="#actualizacion-del-2-de-agosto-de-2023" aria-hidden="true">#</a> <strong>---Actualización del 2 de agosto de 2023---</strong></h4><p><code>emscripten</code> tiene un método expuesto llamado <code>locateFile</code>, que permite redirigir los archivos cargados utilizando un CDN u otra URL. Por lo tanto, eliminé el método de redirección &quot;hack&quot;.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token function-variable function">locateFile</span><span class="token operator">:</span> <span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> prefix<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&#39;/en/&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> path
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>No estoy seguro de cómo afecta el uso de wasm en múltiples páginas, pero tuve problemas al cambiar entre diferentes pestañas: <code>onRuntimeInitialized</code> solo se ejecuta una vez. Por lo tanto, utilicé la forma más conveniente, rápida y menos propensa a errores para resolver este problema: recargar la página al ingresar.<br> Esto puede ser confuso, pero es la mejor solución que se me ocurrió.</p><h3 id="coop-coep" tabindex="-1"><a class="header-anchor" href="#coop-coep" aria-hidden="true">#</a> COOP-COEP</h3>`,9),U=n("s",null,"acuerdo",-1),O=n("code",null,"sharedbuffer",-1),R={href:"https://github.com/gzuidhof/coi-serviceworker",target:"_blank",rel:"noopener noreferrer"},S={href:"https://caniuse.com/mdn-api_window_credentialless",target:"_blank",rel:"noopener noreferrer"},D=n("h2",{id:"proximos-pasos",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#proximos-pasos","aria-hidden":"true"},"#"),e(" Próximos pasos")],-1),T=n("p",null,'Con la experiencia de desarrollo de esta vez, en realidad hay muchas más cosas que se pueden hacer. Teóricamente, puedo desarrollar cualquier programa en el navegador sin preocuparme por las limitaciones de lenguaje o entorno. Tal vez haya una falta de velocidad de ejecución, pero como dice el refrán: "si funciona, está bien".',-1),F={href:"https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new",target:"_blank",rel:"noopener noreferrer"},I=n("strong",null,"feedback",-1);function B(G,V){const a=r("ExternalLinkIcon");return i(),c("div",null,[n("p",null,[e("Aquí registro aproximadamente una semana de mi proceso de incrustación de páginas wasm en vuepress, que involucra muchos aspectos, incluyendo ("),n("a",p,[e("git submodule"),s(a)]),e(","),n("a",u,[e("emscripten"),s(a)]),e(","),n("a",d,[e("naive-ui"),s(a)]),e(","),n("a",m,[e("COOP-COEP"),s(a)]),e(") la exploración y uso de estas tecnologías. Actualmente, esta "),h,e(" está casi terminada y tiene una buena experiencia en el navegador Chrome.")]),k,n("p",null,[e("Por casualidad, me enteré de que Bilibili lanzó una herramienta de IA llamada "),n("a",g,[e("Real-CUGAN"),s(a)]),e(" y vi su implementación wasm en una "),n("a",b,[e("página web"),s(a)]),e(", así que se me ocurrió la idea de intentar incrustarla en vuepress y ponerla en mi propio blog.")]),v,n("p",null,[e("Esta implementación fue bastante compleja y encontré varios problemas que nunca había enfrentado antes, lo que me dio mucha experiencia. La implementación de todo el "),_,e(" se basó en gran medida en la lógica de "),n("a",f,[e("realcugan-ncnn-webassembly"),s(a)]),e(", pero actualicé la parte de "),y,e(" según "),n("a",q,[e("realcugan-ncnn-webassembly"),s(a)]),e(". A continuación, registraré el proceso de uso y los problemas encontrados para cada una de las tecnologías utilizadas.")]),x,n("p",null,[e("El autor del repositorio "),n("a",w,[e("realcugan-ncnn-webassembly"),s(a)]),e(" en realidad no subió el "),z,e(", por lo que clonar directamente este repositorio y ejecutar "),E,e(" no funcionará y no se podrá determinar la versión del "),j,e(". Por lo tanto, no pude usar la última versión de "),C,e(" que se ejecutó y finalmente confirmé la versión según "),n("a",P,[e("realcugan-ncnn-webassembly"),s(a)]),e(".")]),A,n("p",null,[e("Estas configuraciones y su uso pueden parecer simples, pero en realidad detrás de cada conclusión hay muchos intentos. Puedes encontrar estas configuraciones en "),n("a",L,[e("este repositorio"),s(a)]),e(".")]),N,n("p",null,[e("La política de mismo origen es una barrera impuesta por los navegadores, solo cuando el servidor firma el "),U,e(" mismo origen, puede proporcionarte un "),O,e('. Aquí también se utiliza un método "hack" para que la aplicación wasm funcione correctamente, consultando '),n("a",R,[e("coi-serviceworker"),s(a)]),e(". Debido a esto, esta herramienta solo se puede ejecutar en Chrome y Edge, consulta ("),n("a",S,[e("https://caniuse.com/mdn-api_window_credentialless"),s(a)]),e(").")]),D,T,n("blockquote",null,[n("p",null,[e("Este post está traducido usando ChatGPT, por favor "),n("a",F,[I,s(a)]),e(" si hay alguna omisión.")])])])}const W=t(l,[["render",B],["__file","realcugan-wasm页面开发.html.vue"]]);export{W as default};
