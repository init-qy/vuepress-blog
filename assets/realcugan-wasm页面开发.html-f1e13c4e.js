import{_ as o,r as i,o as r,c,a as n,b as e,d as a,e as t}from"./app-46d51712.js";const p={},l={href:"https://git-scm.com/book/en/v2/Git-Tools-Submodules",target:"_blank",rel:"noopener noreferrer"},d={href:"https://github.com/emscripten-core/emscripten",target:"_blank",rel:"noopener noreferrer"},u={href:"https://naiveui.com",target:"_blank",rel:"noopener noreferrer"},h={href:"https://web.dev/coop-coep/",target:"_blank",rel:"noopener noreferrer"},m=n("a",{href:"../tools/realcugan-ncnn-webassembly"},"tool page",-1),b=n("h2",{id:"background",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#background","aria-hidden":"true"},"#"),e(" Background")],-1),k={href:"https://github.com/bilibili/ailab/tree/main/Real-CUGAN",target:"_blank",rel:"noopener noreferrer"},g={href:"https://real-cugan.animesales.xyz/",target:"_blank",rel:"noopener noreferrer"},f=n("h2",{id:"process",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#process","aria-hidden":"true"},"#"),e(" Process")],-1),v=n("code",null,"wasm",-1),y={href:"https://github.com/hanFengSan/realcugan-ncnn-webassembly",target:"_blank",rel:"noopener noreferrer"},_=n("code",null,"models-pro",-1),w={href:"https://github.com/nihui/realcugan-ncnn-vulkan/tree/master/models/models-pro",target:"_blank",rel:"noopener noreferrer"},x=n("h3",{id:"git-submodule",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#git-submodule","aria-hidden":"true"},"#"),e(" git submodule")],-1),I={href:"https://github.com/hanFengSan/realcugan-ncnn-webassembly",target:"_blank",rel:"noopener noreferrer"},q=n("code",null,"git submodule",-1),T=n("code",null,"git submodule update --init",-1),C=n("code",null,"submodule",-1),N=n("code",null,"ncnn",-1),U={href:"https://github.com/nihui/realcugan-ncnn-vulkan/tree/master/models/models-pro",target:"_blank",rel:"noopener noreferrer"},E=t(`<p>At the same time, I put <code>emsdk</code> into the <code>submodule</code>, so that <code>emscripten</code> can be set directly in <code>github action</code> to complete the subsequent compilation process.</p><h3 id="emscripten" tabindex="-1"><a class="header-anchor" href="#emscripten" aria-hidden="true">#</a> emscripten</h3><p>Because this time I didn&#39;t develop <code>wasm</code> completely, I just made some updates and migrations based on the repository of the great god, so I don&#39;t know much about it, there are only three points to note:</p><ul><li>It is best to specify the version of emscripten because it is not clear whether the new version has destructive updates, and I have not found detailed update documents.</li><li><code>-sEXPORTED_FUNCTIONS</code> specifies the output functions to expose them in <code>Module</code>. If you find <code>_xxFun not defined</code>, you should modify it in <code>CMakeList.txt</code>.</li><li>The build cache needs to be cleared, otherwise there may be unexpected problems.</li></ul><h3 id="introduction-of-unocss-and-naive-ui" tabindex="-1"><a class="header-anchor" href="#introduction-of-unocss-and-naive-ui" aria-hidden="true">#</a> Introduction of Unocss and Naive Ui</h3><p>Unocss is relatively simple, and I have not found any style override issues so far, just need to configure it:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token function">Unocss</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;per-module&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Naive Ui is relatively complex and needs to be divided into several points:</p><ul><li>First, it is impossible to use the automatic reference method of the <code>unplugin</code> series to write code, and manual reference is required.</li><li>Then, you need to wrap the <code>&lt;ClientOnly&gt;</code> component outside the component to skip ssg compilation.</li><li>Components such as message and dialog are used through <code>createDiscreteApi</code>.</li><li>Finally, SSR needs to be set up in order to build successfully:</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>ssr<span class="token operator">:</span> <span class="token punctuation">{</span>
  noExternal<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;naive-ui&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;vueuc&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;date-fns&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10),O={href:"https://github.com/init-qy/vuepress-blog/blob/master/docs/.vuepress/config.ts#L46-L55",target:"_blank",rel:"noopener noreferrer"},P=t(`<h3 id="using-wasm-files" tabindex="-1"><a class="header-anchor" href="#using-wasm-files" aria-hidden="true">#</a> Using wasm files</h3><p>After generating the files using <code>emscripten</code>, we need to place them in the same folder as the model files so that they can be read and used by the application. During the development process, I encountered many difficulties with the file reading location. The generated JavaScript file reads the <code>.bin</code> model using a relative path. In my case, the page path is <code>/tools/realcugan-ncnn-webassembly.html</code>, which means it will attempt to access the file <code>/tools/xxx.bin</code>. This implies that I need to place the generated <code>.js</code>, <code>.wasm</code>, and <code>.bin</code> files in the <code>public/tools</code> folder.</p><p>Additionally, due to support for <code>i18n</code>, the English version of the website <code>/en/tools/realcugan-ncnn-webassembly.html</code> is unable to read the <code>.bin</code> model. This problem can be easily solved on a self-hosted server by writing a redirect in Nginx. However, since my website is deployed on <code>github.io</code>, the simplest and most convenient solution is to place an identical copy of the resource files in the corresponding folder. This solves the problem, but it does consume more repository storage. I have used a rather hacky method here by forcibly redirecting it through a work server.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// do something Redirect</span>
<span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.+\\/en\\/tools\\/.+\\.(js|wasm|bin|param|data|jpg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;/en/tools&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/tools&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">cache</span><span class="token operator">:</span> request<span class="token punctuation">.</span>cache<span class="token punctuation">,</span>
    <span class="token literal-property property">credentials</span><span class="token operator">:</span> request<span class="token punctuation">.</span>credentials<span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
    <span class="token literal-property property">integrity</span><span class="token operator">:</span> request<span class="token punctuation">.</span>integrity<span class="token punctuation">,</span>
    <span class="token literal-property property">destination</span><span class="token operator">:</span> request<span class="token punctuation">.</span>destination<span class="token punctuation">,</span>
    <span class="token literal-property property">keepalive</span><span class="token operator">:</span> request<span class="token punctuation">.</span>keepalive<span class="token punctuation">,</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> request<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> request<span class="token punctuation">.</span>mode<span class="token punctuation">,</span>
    <span class="token literal-property property">redirect</span><span class="token operator">:</span> request<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    <span class="token literal-property property">referrer</span><span class="token operator">:</span> request<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span>
    <span class="token literal-property property">referrerPolicy</span><span class="token operator">:</span> request<span class="token punctuation">.</span>referrerPolicy<span class="token punctuation">,</span>
    <span class="token literal-property property">signal</span><span class="token operator">:</span> request<span class="token punctuation">.</span>signal<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="updated-on-august-2-2023" tabindex="-1"><a class="header-anchor" href="#updated-on-august-2-2023" aria-hidden="true">#</a> <strong>---Updated on August 2, 2023---</strong></h4><p><code>emscripten</code> provides the <code>locateFile</code> method, which allows for redirection of the loaded files using a CDN or other URLs. Therefore, I have removed the hacky redirect method.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token function-variable function">locateFile</span><span class="token operator">:</span> <span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> prefix<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> prefix<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&#39;/en/&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> path
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I am not sure about the impact of multiple pages on wasm applications, but I did encounter a problem when switching between tabs: <code>onRuntimeInitialized</code> only executes once. Therefore, I have used the most convenient, fastest, and least error-prone way to solve this problem: reloading the page when entering it.<br> This may be confusing, but it is the best solution I can think of.</p><h3 id="coop-coep" tabindex="-1"><a class="header-anchor" href="#coop-coep" aria-hidden="true">#</a> COOP-COEP</h3>`,9),A=n("s",null,"I agree to this protocol",-1),S=n("code",null,"sharedbuffer",-1),j={href:"https://github.com/gzuidhof/coi-serviceworker",target:"_blank",rel:"noopener noreferrer"},B={href:"https://caniuse.com/mdn-api_window_credentialless",target:"_blank",rel:"noopener noreferrer"},F=n("h2",{id:"next-steps",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#next-steps","aria-hidden":"true"},"#"),e(" Next Steps")],-1),R=n("p",null,'With the experience gained from this development, there are actually many more things that can be done. In theory, I can develop any functional program in the browser without worrying about language or environment limitations. Perhaps there may be some shortcomings in terms of runtime speed, but as the saying goes, "If it works, it works."',-1),L={href:"https://github.com/linyuxuanlin/Wiki_MkDocs/issues/new",target:"_blank",rel:"noopener noreferrer"},D=n("strong",null,"feedback",-1);function G(V,z){const s=i("ExternalLinkIcon");return r(),c("div",null,[n("p",null,[e("Just record my process of embedding a wasm page into vuepress for about a week. It involves many aspects, including "),n("a",l,[e("git submodule"),a(s)]),e(", "),n("a",d,[e("emscripten"),a(s)]),e(", "),n("a",u,[e("naive-ui"),a(s)]),e(", "),n("a",h,[e("COOP-COEP"),a(s)]),e(", and the exploration and use of these technologies. Currently, this "),m,e(" has been roughly completed and has a good experience in the Chrome browser.")]),b,n("p",null,[e("By chance, I learned that Bilibili released an AI tool called "),n("a",k,[e("Real-CUGAN"),a(s)]),e(", and saw its "),n("a",g,[e("web wasm implementation"),a(s)]),e(". Then I had the idea of embedding it into vuepress and putting it on my own blog.")]),f,n("p",null,[e("This implementation is still relatively complex, and I encountered many problems in the middle, all of which were encountered for the first time, which also added a lot of experience. The implementation of the entire "),v,e(" mostly refers to the logic of "),n("a",y,[e("realcugan-ncnn-webassembly"),a(s)]),e(", but it has been updated to the "),_,e(" in "),n("a",w,[e("realcugan-ncnn-webassembly"),a(s)]),e(". Next, I will record the usage and problems encountered according to each technology used.")]),x,n("p",null,[e("The author of "),n("a",I,[e("realcugan-ncnn-webassembly"),a(s)]),e(" did not upload the "),q,e(", so cloning this repository and executing "),T,e(" will not take effect, and the version of "),C,e(" cannot be determined. Therefore, the version of "),N,e(" I ran with the latest version cannot be used at all, and finally, I confirmed the version according to "),n("a",U,[e("realcugan-ncnn-webassembly"),a(s)]),e(".")]),E,n("p",null,[e("These configurations and usage may seem simple, but in reality, each conclusion requires many attempts to reach. These configurations can be found in "),n("a",O,[e("this repository"),a(s)]),e(".")]),P,n("p",null,[e("The same-origin policy is a barrier imposed by browsers. Only when the server signs the "),A,e(" same-origin agreement can it provide you with a "),S,e(". Here, I have also used a hacky method to ensure the proper functioning of the wasm application, referring to "),n("a",j,[e("coi-serviceworker"),a(s)]),e(". Because of this, this tool can only run on Chrome and Edge, as referenced in ("),n("a",B,[e("https://caniuse.com/mdn-api_window_credentialless"),a(s)]),e(").")]),F,R,n("blockquote",null,[n("p",null,[e("This post is translated using ChatGPT, please "),n("a",L,[D,a(s)]),e(" if any omissions.")])])])}const W=o(p,[["render",G],["__file","realcugan-wasm页面开发.html.vue"]]);export{W as default};
